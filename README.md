# LiaHR: Humans Hallucinate Too: Language Models Identify and Correct Subjective Annotation Errors With Label-in-a-Haystack Prompts

Link pending...
<!-- This repo contains the official implementation of [Humans Hallucinate Too: Language Models Identify and Correct Subjective Annotation Errors With Label-in-a-Haystack Prompts](https://arxiv.org/abs/).  -->

## Abstract

> Modeling complex subjective tasks in Natural Language Processing, such as recognizing emotion and morality, is considerably challenging due to significant variation in human annotations. This variation often reflects reasonable differences in semantic interpretations rather than mere noise, necessitating methods to distinguish between legitimate subjectivity and error. We address this challenge by exploring label verification in these contexts using Large Language Models (LLMs). First, we propose a simple In-Context Learning binary filtering baseline that estimates the reasonableness of a document-label pair. We then introduce the Label-in-a-Haystack setting: the query and its label(s) are included in the demonstrations shown to LLMs, which are prompted to predict the label(s) again, while receiving task-specific instructions (e.g., emotion recognition) rather than label copying. We show how the failure to copy the label(s) to the output of the LLM are task-relevant and informative. Building on this, we propose the Label-in-a-Haystack Rectification (LiaHR) framework for subjective label correction: when the model outputs diverge from the reference gold labels, we assign the generated labels to the example instead of discarding it. This approach can be integrated into annotation pipelines to enhance signal-to-noise ratios. Comprehensive analyses, human evaluations, and ecological validity studies verify the utility of LiaHR for label correction.

## Installation

This repo uses `Python 3.10` (type hints, for example, won't work with some previous versions). After you create and activate your virtual environment (with conda, venv, etc), install local dependencies with:

```bash
pip install -e .[dev]
```

## Data preparation

For the experiments you plan to run, do not forget to change the paths in either the bash script or the `./configs/.*/config.yaml` files.

To run the GoEmotions experiments, we recommend using the emotion pooling we set up based on the hierarchical clustering (besides, the bash scripts are set up for it). To do so, create the file `emotion_clustering.json` under the root folder of the dataset with the following contents:

```JSON
{
    "joy": [
        "amusement",
        "excitement",
        "joy",
        "love"
    ],
    "optimism": [
        "desire",
        "optimism",
        "caring"
    ],
    "admiration": [
        "pride",
        "admiration",
        "gratitude",
        "relief",
        "approval",
        "realization"
    ],
    "surprise": [
        "surprise",
        "confusion",
        "curiosity"
    ],
    "fear": [
        "fear",
        "nervousness"
    ],
    "sadness": [
        "remorse",
        "embarrassment",
        "disappointment",
        "sadness",
        "grief"
    ],
    "anger": [
        "anger",
        "disgust",
        "annoyance",
        "disapproval"
    ]
}
```

For MFRC, please create a folder for the dataset (even though we use HuggingFace `datasets` for it), and copy the file `./configs/MFRC/splits.yaml` to that directory. For QueerReclaimLex, copy `./configs/QueerReclaimLex/balanced-splits.json` to the dataset directory.

## Run experiments

Experiments are logged with [legm](https://github.com/gchochla/legm), so refer to the documentation there for an interpretation of the resulting `logs` folder, but navigating should be intuitive enough with some trial and error. Note that some bash scripts have arguments, which are self-explanatory. Make sure to run scripts from the root directory of this repo.

Also, you should create a `.env` file with your OpenAI key if you want to perform experiments with the GPTs.

```bash
OPENAI_API_KEY=<your-openai-key>
```

Then, proceed to run the experiments in `./scripts` from the root of the project:
- `copy-paste-prompt-devirsity.sh`: run diversity experiments
- `copy-paste-prompt-openai.sh`: run LiaHR with OpenAI API.
- `copy-paste-queer.sh`, `copy-paste-queer-llm.sh` & `copy-paste-queer-openai.sh`: QueerReclaimLex experiments (first two are same models but different libraries under the hood)
- `demux-labels-gpt4o-mini.sh` followed by `demux_training.sh`: get labels and train Demux (BERT-based model)
- `plot_figures.sh`: Plot figures based on previous experiments.
- `double-blind.sh`: contains scripts to make the surveys for annotators (`double_blind_generation.py`) and then to analyze the results (`double_blind_test.py`). The files generated by each annotator should be renamed with an underscore followed by an integer: `_#`, as the original name will be considered to be the empty one to be distributed to annotators. The generation also creates a file that has the "ground" truth for each survey question, and it should only be used only by the analysis script.

All other files are used within the bash scripts.